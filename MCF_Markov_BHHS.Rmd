---
title: "MCF_Markov_BHHS.R"
output: github_document
---
=========================================================================================================

```{r echo=FALSE, message=FALSE, warning=FALSE}
setwd('/Users/christina.caddel/Desktop/BHHS/Attribution')
```

## Using the Google Analytics API to run the Markov Model on Multi-Channel Funnel Groupings

Markov makes predictions based on movement through the states of a stochastic process. A visitor’s propensity to convert changes as he/she is exposed to various marketing channels over time. Those differences in propensity provide a great way to measure the influence each marketing channel has on overall conversion.
* Probabilities of different states, rates of transitions among them. Used to recognize and study patterns, the ever-changing market scenario and the statistics of sequential data.
* Pros:
    * Channel sequence as fundamental - more closely aligned to customer’s journey
    * Can better scale to larger number of channels 
    * Can be applied to not only marketing channel but potentially to the individual marketing campaign level - more actionable for personalization
    
We'll compare the Markov model to a Heuristic model to see the difference in attribution
    
### We'll use the RGA package query the API and run the model

```{r warning=FALSE}
# install packages
install.packages("devtools", dependencies=TRUE, repos='http://cran.rstudio.com/')
library(devtools)
install_github("artemklevtsov/RGA")
library(RGA)

authorize(client.id = getOption("rga.client.id"), getOption("rga.client.secret"))
```

## Build the function and query the data

```{r echo=FALSE, message=FALSE, warning=FALSE}

profile_id = "76943133"

```

```{r message=FALSE, warning=FALSE}

# Set report start and end dates
start_date <- "2019-01-01"
end_date <- "2019-05-31"

# Query MCF API to gather conversion path data
mcf_data <- get_mcf(profileId = profile_id, 
                    start.date = start_date, end.date = end_date, 
                    metrics = "mcf:totalConversions, mcf:totalConversionValue", 
                    dimensions = "mcf:conversionDate, mcf:basicChannelGroupingPath", 
                    sort = NULL,
                    filters = NULL, 
                    samplingLevel = NULL, 
                    start.index = NULL, max.results = NULL, fetch.by = NULL)

head(mcf_data)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code due to sensitive GA view id information.

```{r warning=FALSE}
# install attribution packages
install.packages("ChannelAttribution")
library(ChannelAttribution)

install.packages("reshape")
library(reshape)
```

### Build Attribution Models

```{r warning=FALSE}
# build heuristic models i.e. First Touch, Last Touch

H <- heuristic_models(mcf_data, 'basicChannelGroupingPath', 'totalConversions', var_value='totalConversionValue')

head(H)
```

```{r warning=FALSE}
# build Markov Model now

markov_model <- markov_model(mcf_data, 'basicChannelGroupingPath', 
                             'totalConversions', 
                             var_value='totalConversionValue',
                             out_more = TRUE,
                             order = 2)

model_results <- markov_model$result

#rename total_conversions to markov_conversions
colnames(model_results)[colnames(model_results)=="total_conversions"] <- "markov_conversions"

model_results
```

```{r warning=FALSE}
# merge the heuristic and markov data frames, select relevant columns, rename columns, and transform into a dataframe that ggplot2 can use to graph the outcome comparisons

all_attribution <- merge(H, model_results, by='channel_name') 

all_attribution1 <- all_attribution[, (colnames(all_attribution)%in%c('channel_name', 'first_touch_conversions', 'last_touch_conversions', 'linear_touch_conversions', 'markov_conversions'))]

all_attribution1 <- melt(all_attribution1, id='channel_name')

head(all_attribution1)
```

### Plot Attribution Comparisons

```{r warning=FALSE}
# install ggplot package
install.packages("ggplot2")
library(ggplot2)

```

```{r warning=FALSE}
# plot comparison

ggplot(all_attribution1, aes(x = factor(channel_name, level = c('Direct','Paid Search','Organic Search','Other Advertising','Referral','Social Network','Display','Email','(unavailable)')), value, fill = variable)) +
  geom_bar(stat='identity', position='dodge') +
  ggtitle('TOTAL CONVERSIONS') + 
  theme(axis.title.x = element_text(vjust = -2)) +
  theme(axis.title.y = element_text(vjust = +2)) +
  theme(title = element_text(size = 16)) +
  theme(plot.title=element_text(size = 20)) +
  theme(text = element_text(size=9)) +
  ylab("") +
  xlab(" Marketing Channel")
```


As you can see, based on which model we use, the conversion allocations to marketing channels can really vary. This can significantly impact budget distribution and media planning. Selecting the one that accomodates the business model and marketing objectives best to achieve desired KPIs is key.
